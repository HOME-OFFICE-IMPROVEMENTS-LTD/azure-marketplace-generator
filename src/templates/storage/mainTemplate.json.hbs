{
    "$schema": "{{armSchemaUrl}}",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "_generator": {
            "name": "Azure Marketplace Generator",
            "version": "0.1.0",
            "templateHash": "{{generatedDate}}"
        },
        "description": "{{name}} - Managed Application Main Template"
    },
    "parameters": {
        "storageAccountNamePrefix": {
            "type": "string",
            "maxLength": 11,
            "metadata": {
                "description": "Prefix for the storage account name (max 11 characters)"
            }
        },
        "storageAccountType": {
            "type": "string",
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "Storage account type and replication option"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all resources"
            }
        }
    },
    "variables": {
        "nestedTemplateUri": "[uri(deployment().properties.templateLink.uri, 'nestedtemplates/storageAccount.json')]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "{{latestApiVersion 'Microsoft.Resources/deployments'}}",
            "name": "storageDeployment",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "contentVersion": "1.0.0.0",
                    "uri": "[variables('nestedTemplateUri')]"
                },
                "parameters": {
                    "storageAccountNamePrefix": {
                        "value": "[parameters('storageAccountNamePrefix')]"
                    },
                    "storageAccountType": {
                        "value": "[parameters('storageAccountType')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "storageEndpoint": {
            "type": "string",
            "value": "[reference('storageDeployment').outputs.storageEndpoint.value]",
            "metadata": {
                "description": "Primary blob endpoint of the created storage account"
            }
        },
        "storageAccountName": {
            "type": "string",
            "value": "[reference('storageDeployment').outputs.storageAccountName.value]",
            "metadata": {
                "description": "Name of the created storage account"
            }
        }
    }
}