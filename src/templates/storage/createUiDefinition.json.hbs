{
    "$schema": "{{uiSchemaUrl}}",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "config": {
            "isWizard": false,
            "basics": {
                "description": "**{{name}}** by {{publisher}}\n\nManaged Azure Storage Account solution with enterprise-grade configuration options.",
                "subscription": {
                    "constraints": {
                        "validations": [
                            {
                                "permission": "Microsoft.Storage/storageAccounts/write",
                                "message": "Must have permission to create storage accounts"
                            }
                        ]
                    }
                },
                "resourceGroup": {
                    "constraints": {
                        "validations": [
                            {
                                "isValid": "[not(contains(resourceGroup().name, 'temp'))]",
                                "message": "Resource group name cannot contain 'temp'"
                            }
                        ]
                    }
                },
                "location": {
                    "visible": true,
                    "allowedValues": [
                        "eastus",
                        "eastus2", 
                        "westus",
                        "westus2",
                        "westeurope",
                        "northeurope"
                    ]
                }
            }
        },
        "basics": [
            {
                "name": "applicationName",
                "type": "Microsoft.Common.TextBox",
                "label": "Application Name",
                "defaultValue": "{{name}}",
                "toolTip": "Name for this managed application instance",
                "constraints": {
                    "required": true,
                    "regex": "^[a-zA-Z0-9-]{3,24}$",
                    "validationMessage": "Name must be 3-24 characters, alphanumeric and hyphens only"
                }
            }
        ],
        "steps": [
            {
                "name": "storageConfig",
                "label": "Storage Configuration",
                "subLabel": {
                    "preValidation": "Configure storage account settings",
                    "postValidation": "Storage configuration complete"
                },
                "bladeTitle": "Storage Settings",
                "elements": [
                    {
                        "name": "storageAccountPrefix",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Storage Account Name Prefix",
                        "defaultValue": "{{storageAccountName name}}",
                        "toolTip": "Prefix for storage account name (lowercase letters and numbers only)",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-z0-9]{3,11}$",
                            "validationMessage": "Prefix must be 3-11 characters, lowercase letters and numbers only"
                        }
                    },
                    {
                        "name": "storageAccountType",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Storage Account Type",
                        "defaultValue": "Standard locally redundant storage (Standard_LRS)",
                        "toolTip": "Select the replication option for your storage account",
                        "constraints": {
                            "required": true,
                            "allowedValues": [
                                {
                                    "label": "Standard locally redundant storage (Standard_LRS)",
                                    "value": "Standard_LRS"
                                },
                                {
                                    "label": "Standard geo-redundant storage (Standard_GRS)",
                                    "value": "Standard_GRS"
                                },
                                {
                                    "label": "Standard read-access geo-redundant storage (Standard_RAGRS)",
                                    "value": "Standard_RAGRS"
                                },
                                {
                                    "label": "Premium locally redundant storage (Premium_LRS)",
                                    "value": "Premium_LRS"
                                }
                            ]
                        }
                    }
                ]
            },
            {
                "name": "securityConfig",
                "label": "Security & Access Control",
                "subLabel": {
                    "preValidation": "Configure security settings",
                    "postValidation": "Security configuration complete"
                },
                "bladeTitle": "Security Settings",
                "elements": [
                    {
                        "name": "securityInfo",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": true,
                        "options": {
                            "icon": "Info",
                            "text": "🔒 Configure security and access control settings for your storage account. These settings help meet compliance requirements (PCI-DSS, HIPAA, SOC2) and protect your data from unauthorized access."
                        }
                    },
                    {
                        "name": "allowBlobPublicAccess",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "Public Blob Access",
                        "defaultValue": "Disabled",
                        "toolTip": "Control whether blobs can be accessed anonymously. Disable for maximum security (recommended for production).",
                        "constraints": {
                            "required": true,
                            "allowedValues": [
                                {
                                    "label": "Disabled (Recommended) - No public access to blobs",
                                    "value": false
                                },
                                {
                                    "label": "Enabled - Allow public read access to blobs/containers",
                                    "value": true
                                }
                            ]
                        }
                    },
                    {
                        "name": "minimumTlsVersion",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Minimum TLS Version",
                        "defaultValue": "TLS 1.2 (Recommended)",
                        "toolTip": "Minimum TLS version required for requests. TLS 1.2 is required for PCI-DSS compliance.",
                        "constraints": {
                            "required": true,
                            "allowedValues": [
                                {
                                    "label": "TLS 1.0 (Legacy - Not recommended)",
                                    "value": "TLS1_0"
                                },
                                {
                                    "label": "TLS 1.1 (Legacy - Not recommended)",
                                    "value": "TLS1_1"
                                },
                                {
                                    "label": "TLS 1.2 (Recommended)",
                                    "value": "TLS1_2"
                                }
                            ]
                        }
                    },
                    {
                        "name": "supportsHttpsTrafficOnly",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "HTTPS Traffic Only",
                        "defaultValue": "Enabled",
                        "toolTip": "Require HTTPS for all requests. HTTP requests will be rejected.",
                        "constraints": {
                            "required": true,
                            "allowedValues": [
                                {
                                    "label": "Enabled (Recommended) - HTTPS required",
                                    "value": true
                                },
                                {
                                    "label": "Disabled - Allow HTTP traffic",
                                    "value": false
                                }
                            ]
                        }
                    },
                    {
                        "name": "publicNetworkAccess",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "Public Network Access",
                        "defaultValue": "Enabled",
                        "toolTip": "Control access from public networks. Disable for private endpoint-only access (requires private endpoint configuration).",
                        "constraints": {
                            "required": true,
                            "allowedValues": [
                                {
                                    "label": "Enabled - Allow public network access",
                                    "value": "Enabled"
                                },
                                {
                                    "label": "Disabled - Private endpoints only",
                                    "value": "Disabled"
                                }
                            ]
                        }
                    },
                    {
                        "name": "privateEndpointWarning",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": "[equals(steps('securityConfig').publicNetworkAccess, 'Disabled')]",
                        "options": {
                            "icon": "Warning",
                            "text": "⚠️ Private endpoint access requires additional configuration. Ensure you have private endpoints configured before disabling public access, or you will lose access to your storage account."
                        }
                    },
                    {
                        "name": "authenticationSection",
                        "type": "Microsoft.Common.Section",
                        "label": "Authentication Settings",
                        "elements": [
                            {
                                "name": "defaultToOAuthAuthentication",
                                "type": "Microsoft.Common.CheckBox",
                                "label": "Default to OAuth Authentication",
                                "defaultValue": false,
                                "toolTip": "When enabled, requests default to Azure AD (OAuth) authentication instead of Shared Key"
                            },
                            {
                                "name": "allowSharedKeyAccess",
                                "type": "Microsoft.Common.OptionsGroup",
                                "label": "Shared Key Authentication",
                                "defaultValue": "Disabled",
                                "toolTip": "Control whether Shared Key authentication is allowed. Disabling enhances security but requires Azure AD authentication.",
                                "constraints": {
                                    "required": true,
                                    "allowedValues": [
                                        {
                                            "label": "Disabled (Recommended) - Azure AD only",
                                            "value": false
                                        },
                                        {
                                            "label": "Enabled - Allow Shared Key auth",
                                            "value": true
                                        }
                                    ]
                                }
                            },
                            {
                                "name": "sharedKeyWarning",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[equals(steps('securityConfig').authenticationSection.allowSharedKeyAccess, false)]",
                                "options": {
                                    "icon": "Info",
                                    "text": "🔐 Shared Key authentication is disabled. Your applications must use Azure AD authentication (OAuth). This provides better security and is required for many compliance frameworks."
                                }
                            }
                        ]
                    },
                    {
                        "name": "encryptionSection",
                        "type": "Microsoft.Common.Section",
                        "label": "Encryption Settings",
                        "elements": [
                            {
                                "name": "requireInfrastructureEncryption",
                                "type": "Microsoft.Common.CheckBox",
                                "label": "Enable Infrastructure Encryption (Double Encryption)",
                                "defaultValue": false,
                                "toolTip": "Apply secondary layer of encryption with platform-managed keys. Provides additional security but cannot be changed after creation."
                            },
                            {
                                "name": "infrastructureEncryptionInfo",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[steps('securityConfig').encryptionSection.requireInfrastructureEncryption]",
                                "options": {
                                    "icon": "Warning",
                                    "text": "⚠️ Infrastructure encryption cannot be disabled after storage account creation. This is a permanent setting."
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "dataProtectionConfig",
                "label": "Data Protection & Backup",
                "subLabel": {
                    "preValidation": "Configure data protection",
                    "postValidation": "Data protection configured"
                },
                "bladeTitle": "Data Protection",
                "elements": [
                    {
                        "name": "dataProtectionInfo",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": true,
                        "options": {
                            "icon": "Info",
                            "text": "🛡️ Configure soft delete, versioning, and change tracking to protect against accidental deletions and track data changes. Soft delete retention adds storage costs proportionally to data churn."
                        }
                    },
                    {
                        "name": "softDeleteSection",
                        "type": "Microsoft.Common.Section",
                        "label": "Soft Delete Protection",
                        "elements": [
                            {
                                "name": "blobSoftDeleteDays",
                                "type": "Microsoft.Common.Slider",
                                "label": "Blob Soft Delete Retention (Days)",
                                "subLabel": "days",
                                "defaultValue": 7,
                                "min": 0,
                                "max": 365,
                                "showStepMarkers": false,
                                "toolTip": "Number of days to retain deleted blobs. Set to 0 to disable. Recommended: 7-30 days for production.",
                                "constraints": {
                                    "required": true
                                }
                            },
                            {
                                "name": "containerSoftDeleteDays",
                                "type": "Microsoft.Common.Slider",
                                "label": "Container Soft Delete Retention (Days)",
                                "subLabel": "days",
                                "defaultValue": 7,
                                "min": 0,
                                "max": 365,
                                "showStepMarkers": false,
                                "toolTip": "Number of days to retain deleted containers. Set to 0 to disable. Recommended: 7-30 days for production.",
                                "constraints": {
                                    "required": true
                                }
                            },
                            {
                                "name": "softDeleteCostWarning",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[or(greater(steps('dataProtectionConfig').softDeleteSection.blobSoftDeleteDays, 0), greater(steps('dataProtectionConfig').softDeleteSection.containerSoftDeleteDays, 0))]",
                                "options": {
                                    "icon": "Info",
                                    "text": "💰 Soft delete retention increases storage costs by keeping deleted data for the retention period. Cost impact is proportional to your data churn rate. Estimate: ~1-10% additional storage costs for typical workloads."
                                }
                            }
                        ]
                    },
                    {
                        "name": "versioningSection",
                        "type": "Microsoft.Common.Section",
                        "label": "Versioning & Change Tracking",
                        "elements": [
                            {
                                "name": "enableVersioning",
                                "type": "Microsoft.Common.CheckBox",
                                "label": "Enable Blob Versioning",
                                "defaultValue": false,
                                "toolTip": "Automatically maintain previous versions of blobs. Useful for audit trails and rollback capabilities. Increases storage costs."
                            },
                            {
                                "name": "versioningInfo",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[steps('dataProtectionConfig').versioningSection.enableVersioning]",
                                "options": {
                                    "icon": "Info",
                                    "text": "📊 Versioning keeps all versions of modified blobs. Storage costs increase based on modification frequency. Best for compliance and audit requirements."
                                }
                            },
                            {
                                "name": "changeFeedEnabled",
                                "type": "Microsoft.Common.CheckBox",
                                "label": "Enable Change Feed (Audit Log)",
                                "defaultValue": false,
                                "toolTip": "Track all create, update, and delete operations. Required for some compliance frameworks and useful for audit trails."
                            },
                            {
                                "name": "changeFeedInfo",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[steps('dataProtectionConfig').versioningSection.changeFeedEnabled]",
                                "options": {
                                    "icon": "Info",
                                    "text": "📝 Change feed provides ordered, durable log of all changes. Perfect for compliance, auditing, and building event-driven architectures."
                                }
                            },
                            {
                                "name": "lastAccessTimeTrackingEnabled",
                                "type": "Microsoft.Common.CheckBox",
                                "label": "Enable Last Access Time Tracking",
                                "defaultValue": false,
                                "toolTip": "Track when blobs were last accessed. Useful for lifecycle management policies to automatically tier or delete old data."
                            },
                            {
                                "name": "lastAccessInfo",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[steps('dataProtectionConfig').versioningSection.lastAccessTimeTrackingEnabled]",
                                "options": {
                                    "icon": "Info",
                                    "text": "⏱️ Last access time tracking enables data lifecycle policies to automatically move rarely-accessed data to cheaper tiers or delete it. Cost optimization feature."
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "serviceSelection",
                "label": "Service Selection",
                "subLabel": {
                    "preValidation": "Choose your storage services",
                    "postValidation": "Services selected"
                },
                "bladeTitle": "Storage Services",
                "elements": [
                    {
                        "name": "serviceInfo",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": true,
                        "options": {
                            "icon": "Info",
                            "text": "Azure Storage Account offers multiple services beyond basic blob storage. Select the services you need for your solution. Each service unlocks different business capabilities and use cases."
                        }
                    },
                    {
                        "name": "enableStaticWebsite",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Enable Static Website Hosting",
                        "defaultValue": false,
                        "toolTip": "Host static websites directly from your storage account - perfect for web apps, documentation sites, and frontend applications"
                    },
                    {
                        "name": "websiteConfiguration",
                        "type": "Microsoft.Common.Section",
                        "label": "Website Configuration",
                        "visible": "[steps('serviceSelection').enableStaticWebsite]",
                        "elements": [
                            {
                                "name": "websiteIndexDocument",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Index Document",
                                "defaultValue": "index.html",
                                "toolTip": "Default document for your website root",
                                "constraints": {
                                    "required": true,
                                    "regex": "^.+\\.(html|htm)$",
                                    "validationMessage": "Must be an HTML file"
                                }
                            },
                            {
                                "name": "websiteErrorDocument",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Error Document",
                                "defaultValue": "404.html",
                                "toolTip": "Custom error page for 404 errors",
                                "constraints": {
                                    "required": true,
                                    "regex": "^.+\\.(html|htm)$",
                                    "validationMessage": "Must be an HTML file"
                                }
                            }
                        ]
                    },
                    {
                        "name": "enableTables",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Enable Table Storage (NoSQL Database)",
                        "defaultValue": false,
                        "toolTip": "Add NoSQL database capabilities - ideal for structured data, user profiles, device data, and metadata storage"
                    },
                    {
                        "name": "enableQueues",
                        "type": "Microsoft.Common.CheckBox", 
                        "label": "Enable Queue Storage (Message Processing)",
                        "defaultValue": false,
                        "toolTip": "Enable message queuing for asynchronous processing, task scheduling, and building event-driven architectures"
                    },
                    {
                        "name": "enableFileShares",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Enable File Storage (Network Drives)",
                        "defaultValue": false,
                        "toolTip": "Create network file shares accessible via SMB protocol - perfect for shared application data and legacy application migration"
                    },
                    {
                        "name": "eventGridSection",
                        "type": "Microsoft.Common.Section",
                        "label": "🚀 Automation & Integration (Premium Feature)",
                        "elements": [
                            {
                                "name": "enableEventGrid",
                                "type": "Microsoft.Common.CheckBox",
                                "label": "Enable Event Grid Automation",
                                "defaultValue": false,
                                "toolTip": "Transform your storage into an automation platform! Automatically trigger workflows when files are uploaded, modified, or deleted. Perfect for image processing, document analysis, backup automation, and real-time data pipelines."
                            },
                            {
                                "name": "eventGridConfiguration",
                                "type": "Microsoft.Common.Section",
                                "label": "Event Grid Configuration",
                                "visible": "[steps('serviceSelection').eventGridSection.enableEventGrid]",
                                "elements": [
                                    {
                                        "name": "eventGridSubscriptionName",
                                        "type": "Microsoft.Common.TextBox",
                                        "label": "Event Subscription Name",
                                        "defaultValue": "storage-events",
                                        "toolTip": "Name for your event subscription - identifies this automation rule",
                                        "constraints": {
                                            "required": true,
                                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9\\-]{1,62}[a-zA-Z0-9]$",
                                            "validationMessage": "Must be 3-64 characters, start and end with alphanumeric, can contain hyphens"
                                        }
                                    },
                                    {
                                        "name": "webhookEndpoint",
                                        "type": "Microsoft.Common.TextBox",
                                        "label": "Webhook Endpoint URL (Optional)",
                                        "placeholder": "https://your-api.com/webhook",
                                        "toolTip": "Optional: URL to receive event notifications. Leave empty to configure later through Azure Portal or Logic Apps",
                                        "constraints": {
                                            "required": false,
                                            "regex": "^$|^https:\\/\\/[a-zA-Z0-9][a-zA-Z0-9\\-\\.]*[a-zA-Z0-9]+(:[0-9]+)?(\\/.*)?(\\?.*)?(#.*)?$",
                                            "validationMessage": "Must be a valid HTTPS URL or leave empty"
                                        }
                                    }
                                ]
                            },
                            {
                                "name": "eventGridBusinessInfo",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[steps('serviceSelection').eventGridSection.enableEventGrid]",
                                "options": {
                                    "icon": "Info",
                                    "text": "💰 Premium Revenue Opportunity: Event Grid automation can 3-5x your pricing! Transform from basic storage ($10-50/month) to automation platform ($50-500/month). Common use cases: Image processing workflows, Document analysis pipelines, Real-time data synchronization, Automated backup systems."
                                }
                            }
                        ]
                    },
                    {
                        "name": "businessModelInfo",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": "[or(or(steps('serviceSelection').enableStaticWebsite, steps('serviceSelection').enableTables), or(steps('serviceSelection').enableQueues, steps('serviceSelection').enableFileShares))]",
                        "options": {
                            "icon": "Info",
                            "text": "💡 Business Model Tip: With multiple services enabled, you can offer different pricing tiers - Basic (blob only), Professional (includes web hosting), Enterprise (full multi-service platform). This creates natural upgrade paths and higher customer lifetime value."
                        }
                    }
                ]
            }
        ],
        "outputs": {
            "storageAccountNamePrefix": "[steps('storageConfig').storageAccountPrefix]",
            "storageAccountType": "[steps('storageConfig').storageAccountType]",
            "location": "[location()]",
            "applicationName": "[basics('applicationName')]",
            "allowBlobPublicAccess": "[steps('securityConfig').allowBlobPublicAccess]",
            "minimumTlsVersion": "[steps('securityConfig').minimumTlsVersion]",
            "supportsHttpsTrafficOnly": "[steps('securityConfig').supportsHttpsTrafficOnly]",
            "publicNetworkAccess": "[steps('securityConfig').publicNetworkAccess]",
            "defaultToOAuthAuthentication": "[steps('securityConfig').authenticationSection.defaultToOAuthAuthentication]",
            "allowSharedKeyAccess": "[steps('securityConfig').authenticationSection.allowSharedKeyAccess]",
            "requireInfrastructureEncryption": "[steps('securityConfig').encryptionSection.requireInfrastructureEncryption]",
            "blobSoftDeleteDays": "[steps('dataProtectionConfig').softDeleteSection.blobSoftDeleteDays]",
            "containerSoftDeleteDays": "[steps('dataProtectionConfig').softDeleteSection.containerSoftDeleteDays]",
            "enableVersioning": "[steps('dataProtectionConfig').versioningSection.enableVersioning]",
            "changeFeedEnabled": "[steps('dataProtectionConfig').versioningSection.changeFeedEnabled]",
            "lastAccessTimeTrackingEnabled": "[steps('dataProtectionConfig').versioningSection.lastAccessTimeTrackingEnabled]"
        }
    }
}