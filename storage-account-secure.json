{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "_generator": {
            "name": "Azure Marketplace Generator",
            "version": "0.1.0",
            "templateHash": "enterprise-secure-storage-v1.0"
        },
        "description": "HOME-OFFICE-IMPROVEMENTS-LTD Enterprise Secure Azure Storage Account - ARM Template",
        "author": "HOME-OFFICE-IMPROVEMENTS-LTD",
        "category": "Storage",
        "cost": {
            "estimatedMonthlyUSD": "150-300",
            "description": "Based on UK South pricing for Standard GRS with 1TB storage and moderate transactions"
        },
        "compliance": {
            "standards": ["HOILTD-2024", "ISO-27001", "SOC-2"],
            "securityLevel": "Enterprise"
        }
    },
    "parameters": {
        "storageAccountNamePrefix": {
            "type": "string",
            "minLength": 3,
            "maxLength": 11,
            "metadata": {
                "description": "Prefix for the storage account name following HOME-OFFICE-IMPROVEMENTS-LTD naming conventions (3-11 characters, lowercase alphanumeric)"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "uksouth",
            "allowedValues": [
                "uksouth",
                "ukwest"
            ],
            "metadata": {
                "description": "Azure region for deployment - restricted to UK regions per enterprise policy"
            }
        },
        "virtualNetworkResourceGroupName": {
            "type": "string",
            "metadata": {
                "description": "Resource group containing the virtual network for private endpoint connectivity"
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "metadata": {
                "description": "Virtual network name for private endpoint connectivity"
            }
        },
        "subnetName": {
            "type": "string",
            "metadata": {
                "description": "Subnet name for private endpoint deployment"
            }
        },
        "logAnalyticsWorkspaceResourceId": {
            "type": "string",
            "metadata": {
                "description": "Resource ID of the Log Analytics workspace for audit logging"
            }
        },
        "keyVaultResourceId": {
            "type": "string",
            "metadata": {
                "description": "Resource ID of the Key Vault containing customer-managed encryption keys"
            }
        },
        "keyVaultKeyName": {
            "type": "string",
            "metadata": {
                "description": "Name of the key in Key Vault for customer-managed encryption"
            }
        },
        "keyVaultKeyVersion": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Version of the key in Key Vault (leave empty for latest version)"
            }
        },
        "allowedIPAddresses": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": "Array of allowed IP addresses for network ACL (enterprise firewall IPs)"
            }
        },
        "businessUnit": {
            "type": "string",
            "allowedValues": [
                "IT",
                "Finance", 
                "Operations",
                "Marketing",
                "Legal"
            ],
            "metadata": {
                "description": "Business unit for cost allocation and governance"
            }
        },
        "environment": {
            "type": "string",
            "allowedValues": [
                "Production",
                "Staging",
                "Development",
                "Testing"
            ],
            "metadata": {
                "description": "Environment classification for security and compliance policies"
            }
        },
        "dataClassification": {
            "type": "string",
            "allowedValues": [
                "Public",
                "Internal",
                "Confidential",
                "Restricted"
            ],
            "metadata": {
                "description": "Data classification level for compliance and security controls"
            }
        }
    },
    "variables": {
        "storageAccountName": "[concat(parameters('storageAccountNamePrefix'), uniqueString(resourceGroup().id, parameters('location')))]",
        "privateEndpointName": "[concat(variables('storageAccountName'), '-pe-blob')]",
        "privateDnsZoneName": "privatelink.blob.core.windows.net",
        "pvtEndpointDnsGroupName": "[concat(variables('privateEndpointName'), '/mydnsgroupname')]",
        "subnetResourceId": "[resourceId(parameters('virtualNetworkResourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetName'))]",
        "diagnosticSettingsName": "[concat(variables('storageAccountName'), '-diagnostics')]",
        "enterpriseTags": {
            "Company": "HOME-OFFICE-IMPROVEMENTS-LTD",
            "BusinessUnit": "[parameters('businessUnit')]",
            "Environment": "[parameters('environment')]",
            "DataClassification": "[parameters('dataClassification')]",
            "CreatedBy": "Azure Marketplace Generator",
            "CreatedDate": "[utcNow('yyyy-MM-dd')]",
            "Purpose": "Enterprise Secure Storage",
            "Compliance": "HOILTD-2024",
            "CostCenter": "[concat('CC-', parameters('businessUnit'))]",
            "Owner": "IT-Storage-Team",
            "MaintenanceWindow": "Saturday 02:00-04:00 UTC"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2023-01-01",
            "name": "[variables('storageAccountName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard_GRS"
            },
            "kind": "StorageV2",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": false,
                "allowCrossTenantReplication": false,
                "defaultToOAuthAuthentication": true,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "publicNetworkAccess": "Disabled",
                "encryption": {
                    "requireInfrastructureEncryption": true,
                    "keySource": "Microsoft.Keyvault",
                    "keyvaultproperties": {
                        "keyname": "[parameters('keyVaultKeyName')]",
                        "keyvaulturi": "[concat('https://', last(split(parameters('keyVaultResourceId'), '/')), '.vault.azure.net/')]",
                        "keyversion": "[if(empty(parameters('keyVaultKeyVersion')), null(), parameters('keyVaultKeyVersion'))]"
                    },
                    "services": {
                        "blob": {
                            "enabled": true,
                            "keyType": "Account"
                        },
                        "file": {
                            "enabled": true,
                            "keyType": "Account"
                        },
                        "table": {
                            "enabled": true,
                            "keyType": "Account"
                        },
                        "queue": {
                            "enabled": true,
                            "keyType": "Account"
                        }
                    }
                },
                "networkAcls": {
                    "bypass": "AzureServices",
                    "defaultAction": "Deny",
                    "ipRules": "[if(empty(parameters('allowedIPAddresses')), createArray(), map(parameters('allowedIPAddresses'), lambda('ip', createObject('value', lambda('ip'), 'action', 'Allow'))))]",
                    "virtualNetworkRules": []
                },
                "immutableStorageWithVersioning": {
                    "enabled": true
                }
            },
            "tags": "[variables('enterpriseTags')]"
        },
        {
            "type": "Microsoft.Network/privateEndpoints",
            "apiVersion": "2023-05-01",
            "name": "[variables('privateEndpointName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ],
            "properties": {
                "subnet": {
                    "id": "[variables('subnetResourceId')]"
                },
                "privateLinkServiceConnections": [
                    {
                        "name": "[variables('privateEndpointName')]",
                        "properties": {
                            "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                            "groupIds": [
                                "blob"
                            ]
                        }
                    }
                ]
            },
            "tags": "[variables('enterpriseTags')]"
        },
        {
            "type": "Microsoft.Network/privateDnsZones",
            "apiVersion": "2020-06-01",
            "name": "[variables('privateDnsZoneName')]",
            "location": "global",
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            ],
            "properties": {},
            "tags": "[variables('enterpriseTags')]"
        },
        {
            "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
            "apiVersion": "2020-06-01",
            "name": "[concat(variables('privateDnsZoneName'), '/', variables('storageAccountName'), '-vnetlink')]",
            "location": "global",
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
            ],
            "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                    "id": "[resourceId(parameters('virtualNetworkResourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
                }
            },
            "tags": "[variables('enterpriseTags')]"
        },
        {
            "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
            "apiVersion": "2023-05-01",
            "name": "[variables('pvtEndpointDnsGroupName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]",
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
            ],
            "properties": {
                "privateDnsZoneConfigs": [
                    {
                        "name": "config1",
                        "properties": {
                            "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Insights/diagnosticSettings",
            "apiVersion": "2021-05-01-preview",
            "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountName'))]",
            "name": "[variables('diagnosticSettingsName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ],
            "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                "logs": [
                    {
                        "category": "StorageRead",
                        "enabled": true,
                        "retentionPolicy": {
                            "enabled": true,
                            "days": 365
                        }
                    },
                    {
                        "category": "StorageWrite", 
                        "enabled": true,
                        "retentionPolicy": {
                            "enabled": true,
                            "days": 365
                        }
                    },
                    {
                        "category": "StorageDelete",
                        "enabled": true,
                        "retentionPolicy": {
                            "enabled": true,
                            "days": 365
                        }
                    }
                ],
                "metrics": [
                    {
                        "category": "Transaction",
                        "enabled": true,
                        "retentionPolicy": {
                            "enabled": true,
                            "days": 90
                        }
                    },
                    {
                        "category": "Capacity",
                        "enabled": true,
                        "retentionPolicy": {
                            "enabled": true,
                            "days": 90
                        }
                    }
                ]
            }
        }
    ],
    "outputs": {
        "storageAccountName": {
            "type": "string",
            "value": "[variables('storageAccountName')]",
            "metadata": {
                "description": "Name of the created secure storage account"
            }
        },
        "storageAccountResourceId": {
            "type": "string",
            "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
            "metadata": {
                "description": "Resource ID of the storage account"
            }
        },
        "primaryBlobEndpoint": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').primaryEndpoints.blob]",
            "metadata": {
                "description": "Primary blob endpoint URL (accessible only via private endpoint)"
            }
        },
        "privateEndpointIP": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName')), '2023-05-01').customDnsConfigs[0].ipAddresses[0]]",
            "metadata": {
                "description": "Private IP address of the storage account private endpoint"
            }
        },
        "storageAccountPrincipalId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').identity.principalId]",
            "metadata": {
                "description": "System assigned managed identity principal ID for RBAC assignments"
            }
        },
        "complianceStatus": {
            "type": "object",
            "value": {
                "publicAccessDisabled": true,
                "sharedKeyAccessDisabled": true,
                "httpsOnlyEnabled": true,
                "tlsMinimumVersion": "TLS1_2",
                "encryptionAtRest": "CustomerManagedKeys",
                "privateEndpointEnabled": true,
                "auditLoggingEnabled": true,
                "dataClassification": "[parameters('dataClassification')]",
                "environment": "[parameters('environment')]"
            },
            "metadata": {
                "description": "Compliance status summary for auditing and governance"
            }
        }
    }
}