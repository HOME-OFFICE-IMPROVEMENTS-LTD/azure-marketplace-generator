name: ğŸ¤– Intelligent Dependency Management
on:
  schedule:
    # Run daily at 02:00 UTC for dependency monitoring
    - cron: '0 2 * * *'
  
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.github/dependabot.yml'
  
  workflow_dispatch:
    inputs:
      auto_merge_type:
        description: 'Auto-merge dependency type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - none

jobs:
  intelligent-dependency-management:
    name: ğŸš€ Smart Dependency Operations
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js Environment
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“Š Dependency Analysis
        run: |
          echo "ğŸ” Analyzing dependency landscape..."
          
          # Check for available updates
          npm outdated --json > /tmp/outdated.json || echo "{}" > /tmp/outdated.json
          
          # Security audit
          npm audit --json > /tmp/audit.json || echo "{}" > /tmp/audit.json
          
          # Package analysis
          echo "ğŸ“¦ Current dependency status:"
          npm list --depth=0 || echo "Dependencies checked"

      - name: ğŸ›¡ï¸ Security Vulnerability Assessment
        run: |
          echo "ğŸ”’ Assessing security vulnerabilities..."
          
          # Count vulnerabilities by severity
          CRITICAL=$(cat /tmp/audit.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat /tmp/audit.json | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(cat /tmp/audit.json | jq '.metadata.vulnerabilities.moderate // 0')
          LOW=$(cat /tmp/audit.json | jq '.metadata.vulnerabilities.low // 0')
          
          echo "ğŸš¨ Critical: $CRITICAL"
          echo "âš ï¸ High: $HIGH"  
          echo "ğŸ“‹ Moderate: $MODERATE"
          echo "â„¹ï¸ Low: $LOW"
          
          # Fail if critical or high vulnerabilities
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âŒ Critical security vulnerabilities detected!"
            echo "::error::Critical or high severity vulnerabilities found"
            exit 1
          fi

      - name: ğŸ¤– Automated Dependabot PR Management
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ¤– Managing Dependabot pull requests..."
          
          # Get all open Dependabot PRs
          gh pr list --author "app/dependabot" --json number,title,headRefName > /tmp/dependabot_prs.json
          
          # Process each Dependabot PR
          cat /tmp/dependabot_prs.json | jq -r '.[] | "\(.number)|\(.title)|\(.headRefName)"' | while IFS='|' read -r pr_number pr_title branch_name; do
            echo "ğŸ“‹ Processing PR #$pr_number: $pr_title"
            
            # Check if it's a patch or minor update
            if echo "$pr_title" | grep -qE "(patch|minor)" && echo "$pr_title" | grep -qvE "(major|breaking)"; then
              echo "âœ… Auto-merging safe dependency update: PR #$pr_number"
              
              # Wait for checks to complete
              sleep 30
              
              # Check PR status
              if gh pr view "$pr_number" --json mergeable,mergeStateStatus | jq -r '.mergeable == "MERGEABLE" and .mergeStateStatus == "CLEAN"' | grep -q true; then
                gh pr merge "$pr_number" --auto --squash --delete-branch
                echo "ğŸ‰ Successfully auto-merged PR #$pr_number"
              else
                echo "â³ PR #$pr_number not ready for merge yet"
              fi
            else
              echo "âš ï¸ Manual review required for PR #$pr_number (major update)"
            fi
          done

      - name: ğŸ“ˆ Dependency Health Report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“Š Generating dependency health report..."
          
          # Count packages
          TOTAL_DEPS=$(npm list --json --depth=0 | jq '.dependencies | length')
          OUTDATED_COUNT=$(cat /tmp/outdated.json | jq 'length')
          
          # Create health report
          cat > /tmp/dependency-report.md << EOF
          ## ğŸ“¦ Dependency Health Report
          
          **Generated:** $(date)
          **Repository:** ${{ github.repository }}
          
          ### ğŸ“Š Summary Statistics
          - **Total Dependencies:** $TOTAL_DEPS
          - **Outdated Packages:** $OUTDATED_COUNT
          - **Security Vulnerabilities:** $(cat /tmp/audit.json | jq '.metadata.vulnerabilities.total // 0')
          
          ### ğŸ›¡ï¸ Security Status
          - **Critical:** $(cat /tmp/audit.json | jq '.metadata.vulnerabilities.critical // 0')
          - **High:** $(cat /tmp/audit.json | jq '.metadata.vulnerabilities.high // 0')
          - **Moderate:** $(cat /tmp/audit.json | jq '.metadata.vulnerabilities.moderate // 0')
          - **Low:** $(cat /tmp/audit.json | jq '.metadata.vulnerabilities.low // 0')
          
          ### ğŸ¤– Automated Actions Taken
          - Dependabot PRs analyzed and processed
          - Safe updates auto-merged
          - Security vulnerabilities assessed
          
          ### ğŸ¯ Recommendations
          - Review any major version updates manually
          - Monitor security advisory channels
          - Keep dependencies up to date regularly
          
          **Status:** $(if [ $(cat /tmp/audit.json | jq '.metadata.vulnerabilities.critical // 0') -eq 0 ] && [ $(cat /tmp/audit.json | jq '.metadata.vulnerabilities.high // 0') -eq 0 ]; then echo "âœ… Healthy"; else echo "âš ï¸ Attention Required"; fi)
          EOF
          
          echo "ğŸ“‹ Dependency health report generated"
          cat /tmp/dependency-report.md

      - name: ğŸ”„ Update Package Metadata
        run: |
          echo "ğŸ”„ Updating package metadata..."
          
          # Update package-lock.json if needed
          if [ -f "package-lock.json" ]; then
            npm audit fix --package-lock-only || echo "No fixes applied"
          fi
          
          # Check for package.json changes
          if git diff --quiet package.json package-lock.json; then
            echo "âœ… No package changes detected"
          else
            echo "ğŸ“ Package changes detected"
            git diff package.json package-lock.json
          fi

      - name: ğŸš¨ Security Alert Integration
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš¨ Creating security alert issue..."
          
          # Create security issue if vulnerabilities found
          gh issue create \
            --title "ğŸš¨ Security Alert: Dependency Vulnerabilities Detected" \
            --label "security,dependencies,automated" \
            --body "## ğŸš¨ Security Alert

          **Critical security vulnerabilities detected in dependencies!**

          ### ğŸ“‹ Details
          - **Detection Time:** $(date)
          - **Workflow:** ${{ github.workflow }}
          - **Critical Vulnerabilities:** $(cat /tmp/audit.json | jq '.metadata.vulnerabilities.critical // 0')
          - **High Vulnerabilities:** $(cat /tmp/audit.json | jq '.metadata.vulnerabilities.high // 0')

          ### ğŸ¯ Required Actions
          - [ ] Review npm audit output
          - [ ] Update vulnerable dependencies
          - [ ] Test application functionality
          - [ ] Deploy security fixes

          ### ğŸ”§ Commands to Run
          \`\`\`bash
          npm audit
          npm audit fix
          npm test
          \`\`\`

          **This issue was automatically created by the security monitoring system.**"

      - name: ğŸ“Š Workflow Summary
        if: always()
        run: |
          echo "ğŸ“ˆ Dependency management workflow completed"
          echo "ğŸ¯ Summary of operations:"
          echo "  âœ… Dependency analysis completed"
          echo "  ğŸ›¡ï¸ Security assessment performed"  
          echo "  ğŸ¤– Dependabot PRs processed"
          echo "  ğŸ“Š Health report generated"
          echo "  ğŸ”„ Package metadata updated"