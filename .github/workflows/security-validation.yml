name: ğŸ”’ Enterprise Security & ARM-TTK Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  actions: read

env:
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  
jobs:
  security-compliance:
    name: ğŸ¢ HOILTD Security Compliance
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        persist-credentials: false
        
    - name: ğŸ” Comprehensive Secrets Scanning
      run: |
        echo "ğŸ” Scanning entire repository for hardcoded secrets..."
        if grep -r "connectionString\|primaryKey\|accessKey\|AccountKey\|DefaultEndpointsProtocol=https" \
             --include="*.json" --include="*.js" --include="*.ts" --include="*.yaml" --include="*.yml" \
             . || \
           find . -name "*.zip" -exec unzip -l {} \; | grep -i "key\|secret\|password" || \
           grep -r "listKeys(" --include="*.json" .; then
          echo "âŒ SECURITY VIOLATION: Secrets found in repository"
          echo "ğŸ¢ HOILTD POLICY: All secrets must be in Azure Key Vault"
          exit 1
        else
          echo "âœ… No hardcoded secrets found - HOILTD compliant"
        fi
    
    - name: ğŸ” Azure Login (SSO Integration) 
      uses: azure/login@eec3c95657c1536435858eda1f3ff5437fee8474 # v2.3.0
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ğŸ›¡ï¸ ARM-TTK Security Validation
      run: |
        echo "ğŸ›¡ï¸ Running ARM-TTK Security Validation..."
        # Install ARM-TTK via PowerShell Gallery (secure)
        pwsh -c "Install-Module -Name arm-ttk -Force -Scope CurrentUser"
        pwsh -c "Import-Module arm-ttk; Test-AzTemplate -TemplatePath './packages/marketplace' -Test 'Outputs Must Not Contain Secrets'"
        
    - name: ğŸ“¦ Node.js Setup
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“‹ Dependencies Security Audit
      run: |
        npm ci
        npm audit --audit-level moderate
        
    - name: ğŸ”§ TypeScript Strict Compilation
      run: |
        npm run build
        
    - name: ğŸ§ª Security Tests
      run: |
        npm test
        
    - name: ğŸ“Š CodeQL Security Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: typescript, javascript
        
    - name: ğŸ—ï¸ CodeQL Analysis Build
      uses: github/codeql-action/autobuild@v2
      
    - name: ğŸ“ˆ CodeQL Analysis Results
      uses: github/codeql-action/analyze@v2
      
    - name: âœ… Enterprise Compliance Summary
      run: |
        echo "ğŸ¢ HOME-OFFICE-IMPROVEMENTS-LTD Security Validation Complete"
        echo "âœ… ARM-TTK Security Tests: Passed"
        echo "âœ… Secrets Scanning: Clean"
        echo "âœ… Dependency Audit: Secure"
        echo "âœ… TypeScript Compilation: Strict Mode"
        echo "âœ… CodeQL Analysis: Complete"
        echo "ğŸ¯ Ready for Enterprise Deployment"