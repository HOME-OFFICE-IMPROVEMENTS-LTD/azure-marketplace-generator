# v3.0.0 Core Enhancement Plan
**Date:** 21 October 2025  
**Branch:** `feature/v3.0.0-enhanced-core`  
**Status:** üü° Planning Phase  

---

## üéØ Objective
Enhance v3.0.0 core storage template from **minimal baseline** (4 parameters) to **production-ready baseline** (16 parameters) by adding critical security and data protection features.

---

## üìä Current State (v3.0.0-minimal)

### Parameters (4 total):
```json
{
  "storageAccountNamePrefix": "string (max 11 chars)",
  "storageAccountType": "Standard_LRS | Standard_GRS | Standard_RAGRS | Premium_LRS",
  "location": "string",
  "applicationName": "string"
}
```

### Template Structure:
- **mainTemplate.json**: Single storage account resource
- **createUiDefinition.json**: Basic UI with 2 sections
- **viewDefinition.json**: Single overview panel
- **nestedtemplates/storageAccount.json**: Nested deployment

### Validation Results:
- ‚úÖ ARM-TTK: 46/46 tests passed
- ‚úÖ Azure Deployment: Succeeded (22.9 seconds)
- ‚ö†Ô∏è **Issue**: Too minimal for production marketplace release

---

## üéØ Target State (v3.0.0-enhanced)

### New Parameters (12 additional = 16 total):

#### **Category 1: Security & Access Control (7 parameters)**
```json
{
  "allowBlobPublicAccess": {
    "type": "bool",
    "defaultValue": false,
    "metadata": {
      "description": "Allow or disallow public access to all blobs or containers in the storage account"
    }
  },
  "minimumTlsVersion": {
    "type": "string",
    "defaultValue": "TLS1_2",
    "allowedValues": ["TLS1_0", "TLS1_1", "TLS1_2"],
    "metadata": {
      "description": "The minimum TLS version permitted on requests to storage"
    }
  },
  "supportsHttpsTrafficOnly": {
    "type": "bool",
    "defaultValue": true,
    "metadata": {
      "description": "Allows https traffic only to storage service if sets to true"
    }
  },
  "publicNetworkAccess": {
    "type": "string",
    "defaultValue": "Enabled",
    "allowedValues": ["Enabled", "Disabled"],
    "metadata": {
      "description": "Allow or disallow public network access to Storage Account"
    }
  },
  "defaultToOAuthAuthentication": {
    "type": "bool",
    "defaultValue": false,
    "metadata": {
      "description": "A boolean flag which indicates whether the default authentication is OAuth or not"
    }
  },
  "allowSharedKeyAccess": {
    "type": "bool",
    "defaultValue": true,
    "metadata": {
      "description": "Indicates whether the storage account permits requests to be authorized with the account access key via Shared Key"
    }
  },
  "requireInfrastructureEncryption": {
    "type": "bool",
    "defaultValue": false,
    "metadata": {
      "description": "A boolean indicating whether or not the service applies a secondary layer of encryption with platform managed keys for data at rest"
    }
  }
}
```

#### **Category 2: Data Protection (5 parameters)**
```json
{
  "blobSoftDeleteDays": {
    "type": "int",
    "defaultValue": 7,
    "minValue": 1,
    "maxValue": 365,
    "metadata": {
      "description": "Number of days to retain deleted blobs. 0 means soft delete is disabled"
    }
  },
  "containerSoftDeleteDays": {
    "type": "int",
    "defaultValue": 7,
    "minValue": 1,
    "maxValue": 365,
    "metadata": {
      "description": "Number of days to retain deleted containers. 0 means soft delete is disabled"
    }
  },
  "enableVersioning": {
    "type": "bool",
    "defaultValue": false,
    "metadata": {
      "description": "Enable blob versioning to automatically maintain previous versions of blobs"
    }
  },
  "changeFeedEnabled": {
    "type": "bool",
    "defaultValue": false,
    "metadata": {
      "description": "Enable blob change feed for auditing and compliance"
    }
  },
  "lastAccessTimeTrackingEnabled": {
    "type": "bool",
    "defaultValue": false,
    "metadata": {
      "description": "Enable tracking of last access time for lifecycle management policies"
    }
  }
}
```

---

## üìã Technical Requirements

### 1. **Template Architecture**
- **Principle**: Keep nested template pattern for maintainability
- **Structure**:
  ```
  mainTemplate.json (orchestrator)
  ‚îî‚îÄ‚îÄ nestedtemplates/
      ‚îú‚îÄ‚îÄ storageAccount.json (enhanced with new properties)
      ‚îî‚îÄ‚îÄ blobServices.json (NEW - separate blob service configuration)
  ```

### 2. **Backward Compatibility**
- ‚úÖ All new parameters must have sensible defaults
- ‚úÖ Existing 4 parameters remain unchanged
- ‚úÖ Old templates without new parameters still work
- ‚úÖ No breaking changes to outputs

### 3. **UI/UX Design (createUiDefinition.json)**
```
Current UI (2 sections):
1. Basics (name, location)
2. Storage Settings (SKU)

Enhanced UI (4 sections):
1. Basics (name, location, application name)
2. Storage Settings (SKU, redundancy)
3. üÜï Security & Access Control
   - TLS version
   - Public access settings
   - Authentication options
   - Encryption settings
4. üÜï Data Protection
   - Blob soft delete
   - Container soft delete
   - Versioning
   - Change feed
```

### 4. **View Definition Enhancement**
```
Current View (1 panel):
- Overview (storage account details)

Enhanced View (3 panels):
- Overview (storage account details)
- üÜï Security Status (security settings summary)
- üÜï Data Protection Status (backup/versioning status)
```

### 5. **Testing Requirements**
- Unit tests for each new parameter
- Integration tests for security configurations
- ARM-TTK validation (must pass all tests)
- Real Azure deployment tests:
  - With all defaults
  - With custom security settings
  - With data protection enabled

### 6. **Documentation Requirements**
- Update README.md with new parameters
- Create security best practices guide
- Document data protection features
- Add troubleshooting section

---

## üèóÔ∏è Implementation Plan

### Phase 1: Core Template Enhancement (Day 1)
**Tasks:**
1. ‚úÖ Create feature branch
2. ‚è≥ Update `nestedtemplates/storageAccount.json`
   - Add 7 security parameters
   - Add 5 data protection parameters
   - Update resource properties
3. ‚è≥ Create `nestedtemplates/blobServices.json`
   - Separate blob service configuration
   - Configure soft delete policies
   - Configure versioning and change feed
4. ‚è≥ Update `mainTemplate.json`
   - Add new parameters with defaults
   - Pass parameters to nested templates
   - Update outputs (add security/protection status)

### Phase 2: UI/UX Enhancement (Day 1-2)
**Tasks:**
1. ‚è≥ Update `createUiDefinition.json`
   - Add "Security & Access Control" section
   - Add "Data Protection" section
   - Add tooltips and validation
   - Test UI in Azure Portal sandbox
2. ‚è≥ Update `viewDefinition.json`
   - Add "Security Status" panel
   - Add "Data Protection Status" panel
   - Add resource health checks

### Phase 3: Code Generation Enhancement (Day 2)
**Tasks:**
1. ‚è≥ Update Handlebars templates in `src/templates/storage/`
   - Update `mainTemplate.json.hbs`
   - Update `storageAccount.json.hbs`
   - Create `blobServices.json.hbs`
   - Update `createUiDefinition.json.hbs`
   - Update `viewDefinition.json.hbs`
2. ‚è≥ Update TypeScript generator logic
   - Ensure new parameters are handled
   - Add validation for new parameters

### Phase 4: Testing & Validation (Day 2-3)
**Tasks:**
1. ‚è≥ Unit tests
   - Test parameter validation
   - Test default values
   - Test template generation
2. ‚è≥ Integration tests
   - Test ARM-TTK validation
   - Test Azure deployment with defaults
   - Test Azure deployment with custom settings
3. ‚è≥ Security testing
   - Verify TLS enforcement
   - Verify public access blocking
   - Verify encryption settings

### Phase 5: Documentation (Day 3)
**Tasks:**
1. ‚è≥ Update main README.md
2. ‚è≥ Create SECURITY_FEATURES.md
3. ‚è≥ Create DATA_PROTECTION_GUIDE.md
4. ‚è≥ Update CHANGELOG.md

---

## üé® Architecture Decisions

### Decision 1: Nested Templates vs Inline
**Choice:** Keep nested templates  
**Rationale:**
- ‚úÖ Maintains separation of concerns
- ‚úÖ Easier to test individual components
- ‚úÖ Better for future plugin architecture
- ‚úÖ Follows Azure best practices

### Decision 2: Parameter Defaults Strategy
**Choice:** Secure by default, opt-in for less secure  
**Rationale:**
- `allowBlobPublicAccess = false` (secure default)
- `supportsHttpsTrafficOnly = true` (secure default)
- `minimumTlsVersion = TLS1_2` (secure default)
- `blobSoftDeleteDays = 7` (protection enabled by default)
- Users can opt-out if needed

### Decision 3: UI Complexity
**Choice:** 4 sections with collapsible advanced options  
**Rationale:**
- ‚úÖ Balances simplicity with power
- ‚úÖ Beginners see simple defaults
- ‚úÖ Advanced users can customize
- ‚úÖ Follows Azure Portal patterns

### Decision 4: Plugin Boundary
**Choice:** Core = Security + Data Protection, Plugins = Advanced Features  
**Rationale:**
- **Core (v3.0.0):**
  - Basic security (TLS, public access, encryption)
  - Basic data protection (soft delete, versioning)
  - No networking (firewalls, private endpoints)
  - No identity (managed identities, RBAC)
- **Plugins (v3.1+):**
  - Advanced networking (VNet, private endpoints, firewalls)
  - Advanced identity (managed identities, RBAC, AD integration)
  - Advanced features (ADLS Gen2, NFS, SFTP)
  - Lifecycle policies (complex tiering rules)
  - Multi-region replication

---

## üìä Success Criteria

### Must Have (v3.0.0 Release Blockers):
- ‚úÖ All 12 new parameters implemented
- ‚úÖ ARM-TTK validation passes (46+ tests)
- ‚úÖ Real Azure deployment succeeds with defaults
- ‚úÖ Real Azure deployment succeeds with custom settings
- ‚úÖ UI renders correctly in Azure Portal
- ‚úÖ Security settings are enforced
- ‚úÖ Data protection features work
- ‚úÖ All unit tests pass (78+ tests)
- ‚úÖ Documentation updated

### Should Have (Nice to Have):
- üéØ Performance benchmarks (deployment time < 30s)
- üéØ Cost estimation in UI
- üéØ Security score calculation
- üéØ Compliance framework mapping (PCI-DSS, HIPAA, SOC2)

### Won't Have (Deferred to Plugins):
- ‚ùå Private endpoints
- ‚ùå VNet integration
- ‚ùå Managed identities
- ‚ùå RBAC assignments
- ‚ùå Lifecycle policies
- ‚ùå ADLS Gen2
- ‚ùå NFS/SFTP

---

## üöÄ Risk Assessment

### High Risk:
- **Risk**: UI complexity overwhelms users
  - **Mitigation**: Use sensible defaults, collapsible sections, good tooltips
- **Risk**: Breaking changes to existing deployments
  - **Mitigation**: All new parameters optional with defaults

### Medium Risk:
- **Risk**: ARM-TTK validation fails with new parameters
  - **Mitigation**: Test early and often, follow Azure best practices
- **Risk**: Deployment time increases
  - **Mitigation**: Keep nested templates efficient, benchmark performance

### Low Risk:
- **Risk**: Documentation becomes outdated
  - **Mitigation**: Document as we build, use examples

---

## üìà Post-Enhancement Roadmap

### v3.0.0 (This Enhancement):
- Basic storage account + security + data protection

### v3.1.0 (Q4 2025):
- **Plugins Framework**: Plugin architecture implementation
- **Networking Plugin**: VNet, private endpoints, firewalls
- **Identity Plugin**: Managed identities, RBAC

### v3.2.0 (Q1 2026):
- **Advanced Features Plugin**: ADLS Gen2, NFS, SFTP
- **Lifecycle Plugin**: Complex lifecycle policies
- **Monitoring Plugin**: Diagnostics, metrics, alerts

### v4.0.0 (Q2 2026):
- **Multi-Resource Support**: Not just storage accounts
- **SaaS/PaaS/IaaS Expansion**: Other Azure services
- **Marketplace Evolution**: Full marketplace generator platform

---

## ü§ù Stakeholder Sign-Off

- [ ] **Product Owner**: Architecture approved
- [ ] **Technical Lead**: Implementation plan approved
- [ ] **QA Lead**: Testing strategy approved
- [ ] **Documentation Lead**: Documentation plan approved

---

## üìù Notes

### Key Insights from Research:
1. Microsoft's Azure Verified Modules (AVM) include 50+ parameters for storage accounts
2. Security and data protection are considered "baseline" features, not advanced
3. Marketplace reviewers expect production-ready solutions with security best practices
4. Current v3.0.0 is too minimal for marketplace acceptance

### Strategic Decisions:
1. **Core should be production-ready, not minimal** - Better to delay release than ship poor product
2. **Secure by default** - Users can opt-out of security if needed
3. **Plugin boundary is clear** - Core = secure baseline, Plugins = advanced features
4. **Future-proof architecture** - Designed for SaaS/PaaS/IaaS expansion

---

**Status:** üü¢ Ready to proceed with implementation  
**Next Action:** Begin Phase 1 - Core Template Enhancement  
**Estimated Completion:** 3 days (21 Oct - 24 Oct 2025)
